name: 'Automated Release'

on:
  workflow_dispatch:
    inputs:
      release_branch:
        type: string
        description: 'Branch to create release from (e.g., main, 3.4, feature/xyz)'
        required: true
      version_type:
        required: true
        type: choice
        description: 'Version increment type'
        options:
          - current  # For first release - keeps version as-is (3.4.4)
          - patch    # 3.4.4 ‚Üí 3.4.5
          - minor    # 3.4.4 ‚Üí 3.5.0  
          - major    # 3.4.4 ‚Üí 4.0.0
      dry_run:
        type: boolean
        description: 'Dry run (test without creating actual release)?'
        required: false
        default: true
      deploy_to_wporg:
        type: boolean
        description: 'Deploy to WordPress.org theme repository?'
        required: false
        default: false
      slack_channel:
        type: string
        description: 'Slack channel for notifications'
        required: false
        default: '#release'

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '18'
  PHP_VERSION: '7.4'
  COMPOSER_VERSION: '2'

jobs:
  release:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_branch }}
          fetch-depth: 0
      
      - name: Load Release Configuration
        id: config
        run: |
          echo "üìã Loading release configuration..."
          CONFIG_FILE=".github/config/release.json"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå Error: Release configuration file not found: $CONFIG_FILE"
            exit 1
          fi
          
          # Validate JSON syntax
          if ! jq empty "$CONFIG_FILE" 2>/dev/null; then
            echo "‚ùå Error: Invalid JSON in release configuration"
            exit 1
          fi
          
          # Load configuration values
          ALLOWED_REPOS=$(jq -r '.security.allowed_repositories[]' "$CONFIG_FILE" | tr '\n' ' ')
          BLOCKED_ACTORS=$(jq -r '.security.blocked_actors[]' "$CONFIG_FILE" | tr '\n' ' ')
          RELEASE_BRANCHES=$(jq -r '.repository.release_branches[]' "$CONFIG_FILE" | tr '\n' ' ')
          CONFIG_THEME_SLUG=$(jq -r '.release.wordpress_org.theme_slug' "$CONFIG_FILE")
          AUTO_DEPLOY_ENABLED=$(jq -r '.release.wordpress_org.auto_deploy' "$CONFIG_FILE")
          
          echo "ALLOWED_REPOS=$ALLOWED_REPOS" >> $GITHUB_ENV
          echo "BLOCKED_ACTORS=$BLOCKED_ACTORS" >> $GITHUB_ENV
          echo "RELEASE_BRANCHES=$RELEASE_BRANCHES" >> $GITHUB_ENV
          echo "CONFIG_THEME_SLUG=$CONFIG_THEME_SLUG" >> $GITHUB_ENV
          echo "AUTO_DEPLOY_ENABLED=$AUTO_DEPLOY_ENABLED" >> $GITHUB_ENV
          
          echo "‚úÖ Release configuration loaded successfully"
          echo "   - Theme slug: $CONFIG_THEME_SLUG"
          echo "   - Auto-deploy enabled: $AUTO_DEPLOY_ENABLED"
      
      - name: Pre-flight checks
        run: |
          echo "üîç Pre-flight checks..."
          echo "Release Branch: ${{ inputs.release_branch }}"
          echo "Current Branch: ${{ github.ref_name }}"
          echo "Version Type: ${{ inputs.version_type }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo "Deploy to WordPress.org: ${{ inputs.deploy_to_wporg }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "üß™ **DRY RUN MODE** - No actual release will be created"
          fi
          
          # Repository permissions validation
          REPO_ALLOWED=false
          for allowed_repo in ${{ env.ALLOWED_REPOS }}; do
            if [ "${{ github.repository }}" == "$allowed_repo" ]; then
              REPO_ALLOWED=true
              break
            fi
          done
          
          if [ "$REPO_ALLOWED" != "true" ]; then
            echo "‚ö†Ô∏è  Warning: Running on unauthorized repository: ${{ github.repository }}"
          fi
          
          # Check actor permissions
          for blocked_actor in ${{ env.BLOCKED_ACTORS }}; do
            if [ "${{ github.actor }}" == "$blocked_actor" ]; then
              echo "‚ùå Error: Blocked actor cannot create releases: ${{ github.actor }}"
              exit 1
            fi
          done
          
          # Check if the specified branch exists
          if ! git show-ref --verify --quiet refs/remotes/origin/${{ inputs.release_branch }}; then
            echo "‚ùå Error: Branch '${{ inputs.release_branch }}' does not exist"
            echo "üí° Available branches:"
            git branch -r --format='%(refname:short)' | sed 's/origin\///' | head -10
            exit 1
          fi
          
          # Check if selected release branch is allowed (if configured)
          if [ -n "${{ env.RELEASE_BRANCHES }}" ]; then
            BRANCH_ALLOWED=false
            for release_branch in ${{ env.RELEASE_BRANCHES }}; do
              if [ "${{ inputs.release_branch }}" == "$release_branch" ]; then
                BRANCH_ALLOWED=true
                break
              fi
            done
            
            if [ "$BRANCH_ALLOWED" != "true" ]; then
              echo "‚ö†Ô∏è  Warning: Branch '${{ inputs.release_branch }}' is not in configured release branches"
              echo "üìã Configured release branches: ${{ env.RELEASE_BRANCHES }}"
              echo "üîÑ Continuing anyway - remove this branch from release.json if releases should be blocked"
            fi
          fi
          
          # Check for uncommitted changes
          if ! git diff --quiet; then
            echo "‚ùå Error: Uncommitted changes found"
            exit 1
          fi
          
          echo "‚úÖ Pre-flight checks passed"
      
      - name: Install Dependencies
        uses: ./.github/actions/install-dependencies-release
        with:
          DEVOPS_TOKEN: ${{ secrets.DEVOPS_TOKEN }}
          CLOUD_DEVOPS_TOKEN: ${{ secrets.CLOUD_DEVOPS_TOKEN }}
      
      - name: Get current version
        id: current-version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "CLEAN_PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV
          echo "Current version: $PACKAGE_VERSION"
      
      - name: Bump Theme Version (Dry Run)
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "üß™ DRY RUN: Would bump version from ${{ env.CLEAN_PACKAGE_VERSION }}"
          
          CURRENT_VERSION="${{ env.CLEAN_PACKAGE_VERSION }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          case "${{ inputs.version_type }}" in
            "current")
              NEW_VERSION="$CURRENT_VERSION"
              ;;
            "major")
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="$NEW_MAJOR.0.0"
              ;;
            "minor")
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
              ;;
            "patch")
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              ;;
          esac
          
          echo "DRY_RUN_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "PACKAGE_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "üß™ DRY RUN: Version would be: $CURRENT_VERSION ‚Üí $NEW_VERSION"
      
      - name: Bump Theme Version (Actual)
        if: ${{ inputs.dry_run == false }}
        uses: ./.github/actions/bump-theme-version-release
        with:
          CLEAN_PACKAGE_VERSION: ${{ env.CLEAN_PACKAGE_VERSION }}
          VERSION_TYPE: ${{ inputs.version_type }}

      - name: Validate changelog for new version
        uses: ./.github/actions/get-changelog-from-readme-release
        with:
          VERSION: ${{ env.PACKAGE_VERSION }}
      
      - name: Build Theme
        id: build
        uses: ./.github/actions/build-theme-release
        with:
          PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}
          BUILD_SCRIPT_PATH: "npm run package:zip"
      
      - name: Set Build Directory
        if: ${{ inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true' }}
        run: |
          BUILD_DIR="hello-elementor"
          
          if [ ! -d "$BUILD_DIR" ]; then
            echo "‚ùå Build directory not found: $BUILD_DIR"
            echo "Available directories:"
            ls -la
            exit 1
          fi
          
          echo "BUILD_DIR=${BUILD_DIR}" >> $GITHUB_ENV
          echo "‚úÖ Build directory set: ${BUILD_DIR}"

      - name: Create GitHub Release (Dry Run)
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "üß™ DRY RUN: Would create GitHub release"
          echo "   - Tag: v${{ env.PACKAGE_VERSION }}"
          echo "   - Build file: ${{ env.BUILD_ZIP_PATH }}"
          echo "   - Changelog: ${{ env.CHANGELOG_FILE }}"
          echo "RELEASE_URL=https://github.com/${{ github.repository }}/releases/tag/v${{ env.PACKAGE_VERSION }}" >> $GITHUB_ENV
      
      - name: Create GitHub Release (Actual)
        if: ${{ inputs.dry_run == false }}
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.PACKAGE_VERSION }}
          name: Hello Elementor v${{ env.PACKAGE_VERSION }}
          body_path: ${{ env.CHANGELOG_FILE }}
          files: ${{ env.BUILD_ZIP_PATH }}
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Release URL
        if: ${{ inputs.dry_run == false }}
        run: |
          echo "RELEASE_URL=${{ steps.create-release.outputs.html_url }}" >> $GITHUB_ENV
      
      # WordPress.org Deployment Section
      - name: WordPress.org Deployment Validation
        if: ${{ inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true' }}
        run: |
          echo "üîç **WordPress.org Deployment Pre-flight**"
          echo "   - Theme: Hello Elementor"
          echo "   - Version: ${{ env.PACKAGE_VERSION }}"
          echo "   - SVN URL: https://themes.svn.wordpress.org/${{ env.CONFIG_THEME_SLUG }}"
          echo "   - Dry run: ${{ inputs.dry_run }}"
          
          # Check if BUILD_DIR is set
          if [ -z "${{ env.BUILD_DIR }}" ]; then
            echo "‚ùå BUILD_DIR environment variable is not set"
            echo "   This means the build step may have failed or BUILD_DIR was not set correctly"
            echo "   Checking available directories:"
            ls -la
            echo ""
            echo "   Expected build directory name: hello-elementor (from package.json name)"
            exit 1
          fi
          
          echo "   - Build directory: ${{ env.BUILD_DIR }}"
          
          # Validate build directory exists
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "‚ùå Build directory not found: ${{ env.BUILD_DIR }}"
            echo "   Available directories:"
            ls -la
            exit 1
          fi
          
          # Validate required theme files
          for file in style.css index.php functions.php readme.txt; do
            if [ ! -f "${{ env.BUILD_DIR }}/$file" ]; then
              echo "‚ùå Required file missing: $file"
              exit 1
            fi
          done
          
          echo "‚úÖ Pre-flight validation passed"
      
      - name: Install SVN (Dry Run)
        if: ${{ inputs.dry_run == true && inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true' }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y subversion
          svn --version
      
      - name: Deploy to WordPress.org (Dry Run)
        if: ${{ inputs.dry_run == true && inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true' }}
        env:
          THEME_VERSION: ${{ env.PACKAGE_VERSION }}
          THEME_SLUG: ${{ env.CONFIG_THEME_SLUG }}
          BUILD_DIR: ${{ env.BUILD_DIR }}
        run: |
          bash .github/scripts/publish-theme-to-wordpress-org-dry-run.sh
      
      - name: Show SVN Status (Dry Run)
        if: ${{ inputs.dry_run == true && inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true' }}
        run: |
          echo "üìä **SVN Status Check - Dry Run**"
          echo ""
          
          SVN_TEMP_DIR="./svn-checkout-temp"
          SVN_URL="https://themes.svn.wordpress.org/${{ env.CONFIG_THEME_SLUG }}"
          BUILD_DIR="${{ env.BUILD_DIR }}"
          VERSION="${{ env.PACKAGE_VERSION }}"
          
          echo "üîç Checking out SVN repository (read-only)..."
          echo "   - SVN URL: $SVN_URL"
          echo "   - Version: $VERSION"
          echo "   - Note: Themes use flat structure with version folders (no trunk/tags)"
          echo ""
          
          if ! command -v svn &> /dev/null; then
            echo "‚ö†Ô∏è  SVN not installed - installing..."
            sudo apt-get update && sudo apt-get install -y subversion
          fi
          
          rm -rf "$SVN_TEMP_DIR"
          svn checkout --depth immediates "$SVN_URL" "$SVN_TEMP_DIR" > /dev/null 2>&1 || {
            echo "‚ö†Ô∏è  Could not checkout repository (may require auth for some operations)"
            echo "   This is normal for private repositories - skipping SVN status check"
            exit 0
          }
          
          echo "‚úÖ SVN repository checked out"
          echo ""
          
          echo "üìÇ **Existing version folders in SVN:**"
          if [ -d "$SVN_TEMP_DIR" ]; then
            EXISTING_VERSIONS=$(ls -1 "$SVN_TEMP_DIR" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | sort -V || echo "")
            if [ -n "$EXISTING_VERSIONS" ]; then
              echo "$EXISTING_VERSIONS" | head -10 | sed 's|^|     |'
              VERSION_COUNT=$(echo "$EXISTING_VERSIONS" | wc -l)
              if [ "$VERSION_COUNT" -gt 10 ]; then
                echo "     ... and $((VERSION_COUNT - 10)) more versions"
              fi
            else
              echo "     (No version folders found - new theme repository)"
            fi
          fi
          echo ""
          
          if [ -d "$SVN_TEMP_DIR/$VERSION" ]; then
            echo "‚ö†Ô∏è  **Version $VERSION already exists in SVN:**"
            ls -la "$SVN_TEMP_DIR/$VERSION" | head -20
            echo ""
            echo "‚ö†Ô∏è  Warning: Version $VERSION already exists in SVN!"
            echo "   This would update the existing version folder"
            echo ""
            
            echo "üìä **Simulating update to version folder $VERSION...**"
            cd "$SVN_TEMP_DIR/$VERSION"
            echo "   Current version folder status:"
            svn status 2>/dev/null || echo "     (Clean working copy)"
            echo ""
            
            if [ -d "$BUILD_DIR" ]; then
              echo "   Copying build files to version folder (simulation)..."
              cp -r "$BUILD_DIR"/* . 2>/dev/null || cp -r "$BUILD_DIR"/. . 2>/dev/null || true
              
              echo ""
              echo "üìä **SVN Status After File Copy (what would be committed):**"
              SVN_STATUS=$(svn status 2>/dev/null || echo "")
              if [ -n "$SVN_STATUS" ]; then
                echo "$SVN_STATUS" | head -50
                TOTAL_CHANGES=$(echo "$SVN_STATUS" | wc -l)
                if [ "$TOTAL_CHANGES" -gt 50 ]; then
                  echo ""
                  echo "     ... and $((TOTAL_CHANGES - 50)) more changes"
                fi
                echo ""
                echo "   Summary:"
                echo "$SVN_STATUS" | grep "^A" | wc -l | xargs -I {} echo "     Added (A): {} files"
                echo "$SVN_STATUS" | grep "^M" | wc -l | xargs -I {} echo "     Modified (M): {} files"
                echo "$SVN_STATUS" | grep "^D" | wc -l | xargs -I {} echo "     Deleted (D): {} files"
                echo "$SVN_STATUS" | grep "^?" | wc -l | xargs -I {} echo "     Untracked (?): {} files"
              else
                echo "     (No changes detected)"
              fi
            fi
            cd - > /dev/null
          else
            echo "üìÇ **Version $VERSION would be created**"
            echo "   New version folder: $SVN_URL/$VERSION"
            echo ""
            
            if [ -d "$BUILD_DIR" ]; then
              echo "üìä **Files that would be uploaded:**"
              FILE_COUNT=$(find "$BUILD_DIR" -type f | wc -l)
              DIR_COUNT=$(find "$BUILD_DIR" -type d | wc -l)
              echo "   Total files: $FILE_COUNT"
              echo "   Total directories: $DIR_COUNT"
            fi
          fi
          echo ""
          
          echo "üìã **Build Files Summary:**"
          echo "   Build directory: $BUILD_DIR"
          if [ -d "$BUILD_DIR" ]; then
            FILE_COUNT=$(find "$BUILD_DIR" -type f | wc -l)
            DIR_COUNT=$(find "$BUILD_DIR" -type d | wc -l)
            echo "   Total files: $FILE_COUNT"
            echo "   Total directories: $DIR_COUNT"
            echo ""
            echo "   File structure (first 30 files):"
            find "$BUILD_DIR" -type f | head -30 | sed 's|^|     |'
            if [ "$FILE_COUNT" -gt 30 ]; then
              echo "     ... and $((FILE_COUNT - 30)) more files"
            fi
          else
            echo "   ‚ùå Build directory not found!"
          fi
          
          echo ""
          echo "üßπ Cleaning up temporary SVN checkout..."
          rm -rf "$SVN_TEMP_DIR"
          echo "‚úÖ SVN status check complete"
      
      - name: Install SVN
        if: ${{ inputs.dry_run == false && inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true' }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y subversion
          svn --version
      
      - name: Deploy to WordPress.org Theme Repository
        if: ${{ inputs.dry_run == false && inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true' }}
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
          THEME_VERSION: ${{ env.PACKAGE_VERSION }}
          THEME_SLUG: ${{ env.CONFIG_THEME_SLUG }}
          BUILD_DIR: ${{ env.BUILD_DIR }}
        run: |
          bash .github/scripts/publish-theme-to-wordpress-org.sh
      
      - name: WordPress.org Deployment Status
        if: ${{ inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true' }}
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "üß™ **WordPress.org SVN Dry Run Complete!**"
            echo ""
            echo "üìã **Validation Results:**"
            echo "   - SVN repository structure: ‚úÖ Validated"
            echo "   - Theme files preparation: ‚úÖ Validated"
            echo "   - File exclusions (build process): ‚úÖ Applied correctly"
            echo "   - Version consistency: ‚úÖ Verified"
            echo "   - WordPress.org compatibility: ‚úÖ Confirmed"
            echo ""
            echo "üöÄ **Ready for Production Deployment!**"
            echo "   - Re-run workflow with dry_run: false to deploy"
            echo "   - All validations passed successfully"
          else
            echo "üöÄ **WordPress.org Theme Deployment Complete!**"
            echo ""
            echo "üì¶ **Deployment Details:**"
            echo "   - Theme: Hello Elementor"
            echo "   - Version: v${{ env.PACKAGE_VERSION }}"
            echo "   - SVN Repository: Updated"
            echo "   - Theme Directory: https://wordpress.org/themes/${{ env.CONFIG_THEME_SLUG }}/"
            echo ""
            echo "‚è∞ **Timeline:**"
            echo "   - SVN commit: Immediate ‚úÖ"
            echo "   - Theme directory update: 15-60 minutes ‚è∞"
            echo "   - WordPress admin visibility: 15-60 minutes ‚è∞"
            echo ""
            echo "‚úÖ **Next Steps:**"
            echo "   - Monitor WordPress.org for theme availability"
            echo "   - Test installation from WordPress admin"
            echo "   - Update support documentation if needed"
          fi
      
      # Repository maintenance - only for actual releases
      - name: Create PR With Bumped Version
        if: ${{ inputs.dry_run == false && inputs.version_type != 'current' }}
        uses: ./.github/actions/create-pr-with-bumped-theme-version-release
        with:
          base_branch: ${{ inputs.release_branch }}
          package_version: ${{ env.NEW_VERSION || env.CLEAN_PACKAGE_VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Main Branch Version
        if: ${{ inputs.dry_run == false && inputs.version_type != 'current' }}
        uses: ./.github/actions/update-main-branch-version-release
        with:
          new_version: ${{ env.NEW_VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Send Slack Notification (Dry Run)
        if: ${{ inputs.dry_run == true && inputs.deploy_to_wporg == true }}
        run: |
          echo "üß™ DRY RUN: Would send Slack notification"
          echo "   - Channel: ${{ inputs.slack_channel }}"
          echo "   - Version: v${{ env.PACKAGE_VERSION }}"
          echo "   - Message: Release preparation complete (DRY RUN)"
      
      - name: Slack Notification Skipped
        if: ${{ inputs.deploy_to_wporg == false }}
        run: |
          echo "üì¢ Slack notification skipped (deploy_to_wporg: false)"
          echo "   - Only WordPress.org deployments trigger Slack notifications"
      
      - name: Send Slack Notification (Actual)
        if: ${{ inputs.dry_run == false && inputs.deploy_to_wporg == true }}
        uses: ./.github/actions/theme-slack-notification-release
        with:
          CLOUD_SLACK_BOT_TOKEN: ${{ secrets.CLOUD_SLACK_BOT_TOKEN }}
          PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}
          BUILD_ZIP_PATH: ${{ env.BUILD_ZIP_PATH }}
          GITHUB_RELEASE_URL: ${{ env.RELEASE_URL }}
          SLACK_CHANNEL: ${{ inputs.slack_channel }}
          WPORG_DEPLOYMENT_STATUS: ${{ (inputs.deploy_to_wporg == true && env.AUTO_DEPLOY_ENABLED == 'true') && 'deployed' || 'skipped' }}
      
      - name: Deployment Summary
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "üß™ **AUTOMATED RELEASE DRY RUN COMPLETE!**"
            echo ""
            echo "üìã **This was a test run - no actual release was created**"
            echo ""
            echo "üîç **What would have happened:**"
            echo "1. Version would be bumped to: v${{ env.PACKAGE_VERSION }}"
            echo "2. Theme would be built: ${{ env.BUILD_ZIP_PATH }}"
            echo "3. GitHub release would be created: ${{ env.RELEASE_URL }}"
            echo "4. Slack notification would be sent to ${{ inputs.slack_channel }}"
            if [ "${{ inputs.deploy_to_wporg }}" == "true" ] && [ "${{ env.AUTO_DEPLOY_ENABLED }}" == "true" ]; then
              echo "5. WordPress.org SVN deployment would be executed"
              echo "   - Theme deployed to WordPress.org theme repository"
              echo "   - SVN trunk and tags updated automatically"
              echo "   - Manual upload process eliminated! üéâ"
            elif [ "${{ inputs.deploy_to_wporg }}" == "false" ]; then
              echo "5. WordPress.org deployment: ‚ö†Ô∏è Skipped (deploy_to_wporg: false)"
            else
              echo "5. WordPress.org deployment: ‚ö†Ô∏è Disabled in config (auto_deploy: false)"
            fi
            echo ""
            echo "‚úÖ **Dry run validation passed - ready for actual release!**"
            echo "   - Re-run this workflow with dry_run: false"
          else
            echo "üöÄ **AUTOMATED RELEASE DEPLOYMENT COMPLETE!**"
            echo ""
            echo "üì¶ **Release Details:**"
            echo "   - Theme: Hello Elementor v${{ env.PACKAGE_VERSION }}"
            echo "   - GitHub Release: ${{ env.RELEASE_URL }}"
            echo "   - Build Package: ${{ env.BUILD_ZIP_PATH }}"
            if [ "${{ inputs.deploy_to_wporg }}" == "true" ] && [ "${{ env.AUTO_DEPLOY_ENABLED }}" == "true" ]; then
              echo "   - WordPress.org: ‚úÖ Automatically deployed"
              echo "   - Theme Directory: https://wordpress.org/themes/${{ env.CONFIG_THEME_SLUG }}/"
              echo "   - Manual upload: ‚ùå No longer required!"
            elif [ "${{ inputs.deploy_to_wporg }}" == "false" ]; then
              echo "   - WordPress.org: ‚ö†Ô∏è Skipped (deploy_to_wporg: false)"
            else
              echo "   - WordPress.org: ‚ö†Ô∏è Disabled in config"
            fi
            echo ""
            echo "‚úÖ **Next Steps:**"
            if [ "${{ inputs.deploy_to_wporg }}" == "true" ] && [ "${{ env.AUTO_DEPLOY_ENABLED }}" == "true" ]; then
              echo "   - Monitor WordPress.org theme directory (15-60 minutes)"
              echo "   - Test theme installation from WordPress admin"
            fi
            echo "   - Update documentation and announce release"
            echo "   - Celebrate the automated deployment! üéä"
          fi
      
      # Error recovery
      - name: Cleanup on Error
        if: ${{ always() && !inputs.dry_run && failure() }}
        run: |
          echo "üßπ Workflow failed - restoring to original state..."
          
          if ! git diff --quiet; then
            echo "‚ö†Ô∏è Found modified files, restoring original versions..."
            git checkout -- package.json functions.php style.css readme.txt 2>/dev/null || true
            echo "‚úÖ Files restored to original state"
          else
            echo "‚ÑπÔ∏è Working directory already clean"
          fi
          
          rm -f temp-changelog-from-readme.txt 2>/dev/null || true
          rm -f *.bak 2>/dev/null || true
          
          echo "üîç Final state check:"
          git status --porcelain || true

